var DICTS = {
    "adjectieven": [
        { ru: "длинный", nl: "lang" },
        { ru: "короткий", nl: "kort" },
        { ru: "высокий", nl: "hoog" },
        { ru: "низкий", nl: "laag" },
        { ru: "толстый", nl: "vet" },
        { ru: "худой", nl: "slank" },
        { ru: "светлый", nl: "light" },
        { ru: "темный", nl: "donker" },
        { ru: "узкий", nl: "dun" },
        { ru: "широкий", nl: "dik" },
        { ru: "открытый", nl: "open" },
        { ru: "закрытый", nl: "dicht" },
        { ru: "кислый", nl: "zuur" },
        { ru: "сладкий", nl: "zoet" },
        { ru: "быстрый", nl: "snel" },
        { ru: "медленный", nl: "traag" },
        { ru: "сложный", nl: "moeilijk" },
        { ru: "простой", nl: "gemakkelijk" },
        { ru: "пустой", nl: "leeg" },
        { ru: "полный", nl: "vol" },
        { ru: "счастливый", nl: "gelukkig" },
        { ru: "грусный", nl: "verdrietig" },
        { ru: "холодный", nl: "koud" },
        { ru: "теплый", nl: "warm" },
        { ru: "красивый", nl: "mooi" },
        { ru: "уродливый", nl: "lelijk" },
        { ru: "короткий", nl: "kort" },
        { ru: "длинный", nl: "lang" },
        { ru: "голый", nl: "naakt" },
        { ru: "одетый", nl: "gekleed" },
        { ru: "прямой", nl: "stijl" },
        { ru: "вьющийся", nl: "gekruld" },
        { ru: "влажный", nl: "nat" },
        { ru: "сухой", nl: "droog" },
        { ru: "много", nl: "veel" },
        { ru: "мало", nl: "weinig" },
        { ru: "бедный", nl: "arm" },
        { ru: "богатый", nl: "rijk" },
        { ru: "тупой", nl: "versleten" },
        { ru: "острый", nl: "scherp" },
        { ru: "гладкий", nl: "glad" },
        { ru: "с колючками", nl: "met stekels" },
        { ru: "правый", nl: "rechter" },
        { ru: "левый", nl: "linker" },
        { ru: "съедобный", nl: "eetbaar" },
        { ru: "ядовитый", nl: "giftig" },
        { ru: "пугающий", nl: "gemeen" },
        { ru: "дружелюбный", nl: "lief" },
        { ru: "черно-белый", nl: "zwart-wit" },
        { ru: "цветной", nl: "gekleurd" },
        { ru: "нижний", nl: "onder" },
        { ru: "верхний", nl: "boven" },
        { ru: "хрупкий", nl: "zwak" }
    ],
    "voornaamwoorden": [
        { ru: "я", nl: "ik" },
        { ru: "ты", nl: "je,jij" },
        { ru: "Вы", nl: "u" },
        { ru: "он", nl: "he,hij" },
        { ru: "она", nl: "ze,zij" },
        { ru: "оно", nl: "het" },
        { ru: "мы", nl: "we,wij" },
        { ru: "вы", nl: "julie" },
        { ru: "они", nl: "ze,zij" },
        { ru: "мой", nl: "mijn" },
        { ru: "твой", nl: "jouw" },
        { ru: "Ваш", nl: "uw" },
        { ru: "его", nl: "zijn" },
        { ru: "её", nl: "haar" },
        { ru: "наш", nl: "ons,onze" },
        { ru: "ваш", nl: "julie" },
        { ru: "их", nl: "hun" }
    ],
    "getallen": [
        { ru: "0", nl: "nul" },
        { ru: "1", nl: "één" },
        { ru: "2", nl: "twee" },
        { ru: "3", nl: "drie" },
        { ru: "4", nl: "vier" },
        { ru: "5", nl: "vijf" },
        { ru: "6", nl: "zes" },
        { ru: "7", nl: "zeven" },
        { ru: "8", nl: "acht" },
        { ru: "9", nl: "negen" },
        { ru: "10", nl: "tien" },
        { ru: "11", nl: "elf" },
        { ru: "12", nl: "twaalf" },
        { ru: "13", nl: "dertien" },
        { ru: "20", nl: "twintig" },
        { ru: "30", nl: "dertig" },
        { ru: "80", nl: "tachtig" },
        { ru: "100", nl: "honderd" },
        { ru: "1000", nl: "duizend" }
    ],
    "werkwoorden-1": [
        { ru: "идти", nl: "gaan" },
        { ru: "иметь", nl: "hebben" },
        { ru: "быть", nl: "zijn" },
        { ru: "смотреть", nl: "kijken" },
        { ru: "слушать", nl: "luisteren" },
        { ru: "играть", nl: "spelen" },
        { ru: "работать", nl: "werken" },
        { ru: "петь", nl: "zingen" },
        { ru: "стирать", nl: "was doen" },
        { ru: "пылесосить", nl: "stofzuigen" },
        { ru: "покупать еду", nl: "boodshapen doen" },
        { ru: "ходить по магазинам", nl: "winkelen" },
        { ru: "выносить мусор", nl: "vuilniszakken buiten zetten" },
        { ru: "готовить", nl: "koken" },
        { ru: "убираться", nl: "poetsen" },
        { ru: "гладить", nl: "strijken" },
        { ru: "гулять", nl: "wandelen" },
        { ru: "идти дождь", nl: "regenen" },
        { ru: "находить", nl: "vinden" },
        { ru: "ставить", nl: "zetten" },
        { ru: "говорить", nl: "zeggen" },
        { ru: "сидеть", nl: "zitten" },
        { ru: "видеть", nl: "zien" },
        { ru: "есть", nl: "eten" },
        { ru: "говорить на языке", nl: "spreken" },
        { ru: "обедать", nl: "lunchen" },
        { ru: "жить", nl: "wonen" },
        { ru: "побеждать", nl: "winnen" },
    ],
    "werkwoorden-2": [
        { ru: "отправляться", nl: "vertrekken" },
        { ru: "брать", nl: "nemen" },
        { ru: "покупать", nl: "kopen" },
        { ru: "спрашивать", nl: "vragen" },
        { ru: "отвечать", nl: "antwoorden" },
        { ru: "стоять", nl: "staan" },
        { ru: "вставать", nl: "opstaan" },
        { ru: "оставаться", nl: "blijven" },
        { ru: "приносить, носить", nl: "brengen" },
        { ru: "мочь", nl: "kunnen" },
        { ru: "завтракать", nl: "ontbijten" },
        { ru: "бегать, ходить пешком", nl: "lopen" },
        { ru: "есть конфетки", nl: "snoepen" },
        { ru: "спать", nl: "slapen" },
        { ru: "навещать", nl: "bezoeken" },
        { ru: "носить одежду", nl: "dragen" },
        { ru: "жаловаться", nl: "klagen" },
        { ru: "писать по буквам", nl: "spellen" },
        { ru: "отдыхать", nl: "rusten" },
        { ru: "жениться", nl: "trouwen" }
    ],
    "3 Jan": [
        { ru: "лемон", nl: "citroen" },
        { ru: "улица", nl: "straat" },
        { ru: "строить", nl: "gebouwen" },
        { ru: "здание", nl: "gebouw" },
        { ru: "автострада", nl: "snelweg" },
        { ru: "дорога", nl: "weg" },
        { ru: "отмечать ДР", nl: "verjaaren" },
        { ru: "день рождения", nl: "verjaardag" },
        { ru: "рождаться", nl: "geboren" },
        { ru: "дата рождения", nl: "geboortedatum" },
        { ru: "поздравлять", nl: "feliciteren" },
        { ru: "поздравляю", nl: "feliciteerd, proficiat" },
        { ru: "именинник", nl: "jarig" },
        { ru: "пасха", nl: "pasen" },
        { ru: "пн. после пасхи", nl: "pasensmaandag" },
        { ru: "календарь", nl: "kalender" },
        { ru: "дата", nl: "datum, data" },
        { ru: "открытка", nl: "kaartje" },
        { ru: "весна", nl: "lente, voorjaar" },
        { ru: "осень", nl: "herfst, najaar" },
        { ru: "лето", nl: "zomer" },
        { ru: "зима", nl: "winter" },
        { ru: "январь", nl: "januari" },
        { ru: "февраль", nl: "februari" },
        { ru: "март", nl: "maart" },
        { ru: "апрель", nl: "april" },
        { ru: "май", nl: "mei" },
        { ru: "июнь", nl: "juni" },
        { ru: "июль", nl: "juli" },
        { ru: "август", nl: "augustus" },
        { ru: "сентябрь", nl: "september" },
        { ru: "октябрь", nl: "oktober" },
        { ru: "ноябрь", nl: "november" },
        { ru: "декабрь", nl: "december" },
        { ru: "подарак", nl: "geschenk,cadeau" }
    ],
    "5 Jan": [
        { ru: "помидор", nl: "tomaat" },
        { ru: "учительница", nl: "lerares" },
        { ru: "учитель", nl: "leraar" },
        { ru: "улыбаться", nl: "glimlachen" },
        { ru: "использовать", nl: "gebruiken,verbruiken" },
        { ru: "причесывать", nl: "kammen" },
        { ru: "причесываться", nl: "zich kammen" },
        { ru: "это возможно", nl: "dat kan" },
        { ru: "это не возможно", nl: "dat kan niet" },
        { ru: "решение", nl: "oplossing" },
        { ru: "все ещё", nl: "nog" },
        { ru: "уже", nl: "al" },
        { ru: "еще не", nl: "nog geen/niet" },
        { ru: "больше не", nl: "geen/niet meer" },
        { ru: "где-либо", nl: "ergens" },
        { ru: "повсюду", nl: "overal" },
        { ru: "нигде", nl: "nergens" },
        { ru: "когда-либо", nl: "ooit" },
        { ru: "иногда", nl: "soms" },
        { ru: "всегда", nl: "altijd" },
        { ru: "никогда", nl: "nooit" },
        { ru: "что-либо", nl: "iets" },
        { ru: "все", nl: "alles" },
        { ru: "ничего", nl: "niets" },
        { ru: "кто-либо", nl: "iemand" },
        { ru: "никто", nl: "niemand" },
        { ru: "звонить", nl: "bellen" },
        { ru: "сильное отрицание", nl: "sterke negatie" },
        { ru: "полностью", nl: "helemaal" },
        { ru: "действительно", nl: "echt" },
        { ru: "абсолютно", nl: "absoluut" },
        { ru: "кончено", nl: "zeker" },
        { ru: "сверху", nl: "boven" },
        { ru: "снизу", nl: "beneden" },
        { ru: "нужно", nl: "heb ... nodig" },
        { ru: "прекрасный", nl: "heerlijk" },
        { ru: "снизу", nl: "beneden" }
    ],
    "10 Jan": [
        { ru: "записываться на прием", nl: "afspraak maken" },
        { ru: "парикмахер", nl: "kapper" },
        { ru: "терапевт", nl: "huisarts" },
        { ru: "стоматолог", nl: "tandarts" },
        { ru: "я хотел бы", nl: "ik wil graag" },
        { ru: "мыть", nl: "wassen" },
        { ru: "стричь", nl: "knippen" },
        { ru: "если можно", nl: "als het kan" },
        { ru: "место", nl: "plek" },
        { ru: "благодарить", nl: "bedanken" },
        { ru: "жалоба", nl: "klacht" },
        { ru: "поясница", nl: "onderrug" },
        { ru: "подойти", nl: "langskomen" },
        { ru: "возможный", nl: "mogelijk" },
        { ru: "возможность", nl: "mogelijkheid" },
        { ru: "резать", nl: "snijden" },
        { ru: "надевать", nl: "aankleden" },
        { ru: "чистить зубы", nl: "tanden poetsen" },
        { ru: "мыть голову", nl: "haar wassen" },
        { ru: "печатать", nl: "typen" },
        { ru: "подметать", nl: "vegen" },
        { ru: "расслабляться", nl: "ontspannen" },
        { ru: "давать постричь волосы", nl: "haar laten knippen" },
        { ru: "просыпаться", nl: "wakker worden" },
        { ru: "кормить", nl: "voeden" },
        { ru: "курить", nl: "roken" },
        { ru: "поливать", nl: "water geven" },
        { ru: "брить", nl: "scheren" },
        { ru: "принимать ванную", nl: "een bad nemen" },
        { ru: "принимать душ", nl: "een douche nemen" }
    ]
};

class Card {
    constructor() {
        this.state = 'init';
        this.node = document.getElementById("card");
        this.node.onclick = () => this.onAnswer();
        document.getElementById("btn-y").onclick = () => this.onRight();
        document.getElementById("btn-n").onclick = () => this.onWrong();
    }

    reset(q, a, onDone) {
        this.question = q;
        this.answer = a;
        this.onDone = onDone;
        this.state = 'question';

        this.node.innerText = this.question;
        document.getElementById("answer").style.display = "none";
    }

    onAnswer() {
        if (this.state !== 'question') {
            return;
        }
        this.state = 'answer';
        this.node.innerText = this.answer;
        document.getElementById("answer").style.display = "flex";
    }

    onRight() {
        if (this.state !== 'answer') {
            return;
        }
        this.state = 'done';
        this.onDone(true);
    }

    onWrong() {
        if (this.state !== 'answer') {
            return;
        }
        this.state = 'done';
        this.onDone(false);
    }
}

class Exercise {
    constructor(card, words) {
        this.card = card;
        this.words = words;
        this.id = -1;
        for (let word of this.words) {
            word.total = 0;
            word.right = 0;
            word.maCorrect = 0.5; // correctness moving average
        };
    }

    getWeight(w) {
        return 1 - w.maCorrect;
    }

    isEligible(id, w) {
        if (id == this.id) {
            return false;
        }
        if (w.maCorrect > 0.90) {
            return false;
        }
        return true;
    }

    select() {
        let weights = [];
        let totalWeight = 0;
        for (let i = 0; i < this.words.length; i++) {
            if (!this.isEligible(i, this.words[i])) {
                continue;
            }
            totalWeight += this.getWeight(this.words[i]);
        }
        if (totalWeight == 0) {
            return -1;
        }
        let p = Math.random() * totalWeight;
        let w = 0;
        for (let i = 0; i < this.words.length; i++) {
            if (!this.isEligible(i, this.words[i])) {
                continue;
            }
            w += this.getWeight(this.words[i]);
            if (p < w) {
                return i;
            }
        }
        console.log("Error generating random word id in Exercise.select()");
        return this.words.length - 1;
    }

    run() {
        this.id = this.select();
        if (this.id == -1) {
            this.congratulate();
            return;
        }
        this.word = this.words[this.id];
        this.card.reset(this.word.ru, this.word.nl, (isCorrect) => this.gatherResult(isCorrect));
    }

    congratulate() {
        document.getElementById("card").innerText = "Je hebt deze woorden geleerd!";
        document.getElementById("answer").style.display = "none";
    }

    gatherResult(isCorrect) {
        this.word.total++;
        if (isCorrect) {
            this.word.right++;
        }
        let maCoef = 0.5;
        this.word.maCorrect = maCoef * this.word.maCorrect + (1 - maCoef) * (isCorrect ? 1 : 0);
        this.run();
    }
}

class DictList {
    constructor() {
        this.card = new Card();
        this.selected = [];
    }

    render() {
        let dicts = document.getElementById("dicts");
        let html = '';
        for (let name in DICTS) {
            html += `<div id="dict-${name}" class="dicts-item">${name}</div>`;
        }
        dicts.innerHTML = html;
        for (let name in DICTS) {
            document.getElementById(`dict-${name}`).onclick = () => this.onToggle(name);
        }
        document.getElementById("btn-exercise").onclick = () => this.onRun();
    }

    onToggle(name) {
        let node = document.getElementById(`dict-${name}`);
        let idx = this.selected.indexOf(name);
        if (idx == -1) {
            this.selected.push(name);
            node.classList.add("dicts-item-selected");
        } else {
            this.selected.splice(idx, 1);
            node.classList.remove("dicts-item-selected");
        }
    }

    onRun() {
        document.getElementById("card").style.display = "";
        document.getElementById("dicts").style.display = "none";
        document.getElementById("dicts-menu").style.display = "none";
        let words = [];
        for (let name of this.selected) {
            for (let word of DICTS[name]) {
                words.push(word);
            }
        }
        let excecise = new Exercise(this.card, words);
        excecise.run();
    }
}
